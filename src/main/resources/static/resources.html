<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRAKA — Resources</title>

  <!-- Chart.js (same as dashboard) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --sidebar-w: 260px;
      --bg:#f4f6fb;
      --card:#ffffff;
      --muted:#7b8896;
      --accent:#2f6ee8;
      --soft:#eef6ff;
      --border:#e6ecf5;
      --radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:#0f1724;
      display:flex;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
      font-size:14px;
    }

    .app {
      display:flex;
      width:100%;
      height:100vh;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-w);
      min-width:var(--sidebar-w);
      height:100vh;
      background:linear-gradient(180deg,#0b1220,#0f1724 70%);
      color:#fff;
      padding:26px 18px;
      display:flex;
      flex-direction:column;
    }
    .brand{
      font-weight:700;
      font-size:20px;
      letter-spacing:0.6px;
      margin-bottom:4px;
    }
    .brand-sub{
      font-size:12px;
      opacity:.85;
      color:rgba(255,255,255,.9);
      margin-top:2px;
    }

    .nav{
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }

    .nav a{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      color:rgba(255,255,255,0.92);
      text-decoration:none;
      font-size:14px;
    }
    .nav a .ico{
      width:20px;height:20px;border-radius:4px;background:rgba(255,255,255,0.08);
      display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;
    }
    .nav a.active{
      background:rgba(255,255,255,0.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .sidebar-footer{
      margin-top:12px;
      border-top:1px solid rgba(255,255,255,0.05);
      padding-top:12px;
    }
    .user-row{display:flex;gap:12px;align-items:center}
    .avatar{
      width:44px;height:44px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),#4fb0ff);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:white;
      font-size:14px;
    }
    .user-info{font-size:13px}
    .user-info .name{font-weight:600}
    .user-info .role{color:rgba(255,255,255,0.85);font-size:12px;margin-top:2px}

    .logout{
      margin-top:10px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
      width:100%;
    }

    /* Main */
    .main{
      flex:1;
      padding:26px;
      overflow:auto;
    }

    .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .header h1{margin:0;font-size:22px}
    .header p{margin:6px 0 0;color:var(--muted);font-size:13px}

    /* (From your resources page code) */
    .tabs{display:flex;gap:20px;border-bottom:1px solid var(--border);margin-bottom:16px;}
    .tab{padding:10px 0;font-weight:600;font-size:14px;color:#334155;border-bottom:2px solid transparent;cursor:pointer;}
    .tab.active{color:var(--accent);border-color:var(--accent);}

    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 18px;}
    .filter-btn{padding:6px 12px;font-size:13px;border-radius:8px;border:1px solid var(--border);background:var(--soft);cursor:pointer;color:#334155;}
    .filter-btn.active{background:#dfe9ff;color:var(--accent);border-color:#cfe0ff;font-weight:600;}

    .grid{
      display:grid;grid-template-columns:repeat(3,1fr);gap:16px;
    }
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(17,24,39,0.04);padding:16px;display:grid;gap:10px;}
    .card h3{margin:0;font-size:16px;font-weight:700}
    .card p{margin:0;font-size:13px;color:var(--muted)}

    .meta{display:flex;align-items:center;justify-content:space-between}
    .tag{padding:4px 8px;font-size:12px;font-weight:600;color:var(--accent);background:var(--soft);border-radius:8px;}
    .download{padding:8px 12px;font-size:13px;font-weight:600;color:white;background:var(--accent);border:none;border-radius:10px;cursor:pointer}

    .links{display:grid;gap:12px;margin-top:20px}
    .link-item{background:var(--card);border-radius:12px;border:1px solid var(--border);padding:14px;display:flex;justify-content:space-between;align-items:center}
    .link-title{font-weight:700;font-size:14px}
    .link-sub{font-size:12px;color:var(--muted)}
    .open{padding:8px 12px;font-size:13px;color:white;background:#0ea5e9;border:none;border-radius:10px;cursor:pointer}

  </style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
      <div>
        <div class="brand">DRAKA</div>
        <div class="brand-sub">Thesis Management</div>
      </div>

      <nav class="nav">
        <a href="index.html"><span class="ico">D</span> Dashboard</a>
        <a href="myresearch.html"><span class="ico">R</span> My Research</a>
        <a class="active" href="resources.html"><span class="ico">S</span> Resources</a>
        <a href="meetings.html"><span class="ico">M</span> Meetings</a>
        <a href="profile.html"><span class="ico">P</span> Profile</a>
        <a href="settings.html"><span class="ico">⚙</span> Settings</a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-row">
          <div class="avatar">OF</div>
          <div class="user-info">
            <div class="name">OFORI</div>
            <div class="role">Graduate Student</div>
          </div>
        </div>
        <button class="logout">Log out</button>
      </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

      <div class="header">
        <div>
          <h1>Resources</h1>
          <p>Your downloadable materials, links and tools</p>
        </div>

        <button onclick="location.href='index.html'"
          style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer">
          ← Back to Dashboard
        </button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active">Documents</div>
        <div class="tab">Useful Links</div>
        <div class="tab">Templates</div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active">All</button>
        <button class="filter-btn">PDF</button>
        <button class="filter-btn">DOCX</button>
        <button class="filter-btn">Guides</button>
        <button class="filter-btn">Data</button>
      </div>

      <!-- Resource Cards -->
      <div class="grid">
        <div class="card">
          <h3>Thesis Format Guide</h3>
          <p>University-approved thesis formatting rules</p>
          <div class="meta">
            <span class="tag">PDF</span>
            <button class="download">Download</button>
          </div>
        </div>

        <div class="card">
          <h3>Sample Literature Review</h3>
          <p>A complete example for structuring Chapter 2</p>
          <div class="meta">
            <span class="tag">DOCX</span>
            <button class="download">Download</button>
          </div>
        </div>

        <div class="card">
          <h3>Research Dataset</h3>
          <p>Clean dataset for testing machine learning algorithms</p>
          <div class="meta">
            <span class="tag">Data</span>
            <button class="download">Download</button>
          </div>
        </div>
      </div>

      <!-- Useful Links -->
      <h2 style="margin-top:32px;">Useful Links</h2>
      <div class="links">
        <div class="link-item">
          <div>
            <div class="link-title">Google Scholar</div>
            <div class="link-sub">Search academic literature</div>
          </div>
          <button class="open">Open</button>
        </div>

        <div class="link-item">
          <div>
            <div class="link-title">ResearchGate</div>
            <div class="link-sub">Find articles and connect with researchers</div>
          </div>
          <button class="open">Open</button>
        </div>
      </div>

    <script>
      async function fetchReportData() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("userId");

        if (!userId) {
          alert("No userId provided in URL");
          return {monthly: [], weekly: []};
        }

        try {
          const res = await fetch(`/report/research/${userId}`, {
            method: "GET",
            headers: {"Content-Type": "application/json"}
          });

          const data = await res.json();

          if (!res.ok) {
            alert("An error occurred: " + data.message);
            return {monthly: [], weekly: []};
          }

          const monthly = Object.entries(data.monthly).map(([month, values]) => ({
            month,
            ...values
          }));

          const weekly = data.weekly.map(w => ({
            week: w.weekName,
            count: w.count
          }));

          const totalChapters = data.totalChapters
          const totalCompletedChapters = data.totalChaptersCompleted;
          const totalSubmittedForStudentChapter = data.totalSubmittedForStudentChapter;
          const totalPendingReviews = data.totalPendingReview

          // Get the element with id "c3"
          const milestoneElement = document.getElementById("c3");
          milestoneElement.textContent = totalCompletedChapters;

          const subElement = milestoneElement.parentElement.querySelector(".sub");
          subElement.textContent = `Out of ${totalChapters} milestones`; // dynamically set new total

          const totalPendingReview = document.getElementById("c2");
          totalPendingReview.textContent = totalPendingReviews;


          const currentChapter = data.currentChapter

          const currentChapterObject = document.getElementById("c1");
          currentChapterObject.textContent = currentChapter;

          const stageSubElement = currentChapterObject.parentElement.querySelector(".sub");
          stageSubElement.textContent = `Stage ${totalSubmittedForStudentChapter} of ${totalChapters}`


          const userInfoDiv = document.querySelector(".user-info"); // the container
          const nameDiv = userInfoDiv.querySelector(".name");
          const roleDiv = userInfoDiv.querySelector(".role");

          nameDiv.textContent = data.lastName.toUpperCase();
          roleDiv.textContent = `${data.researchArea}`;


          const welcomeDiv = document.querySelector(".welcome");
          welcomeDiv.querySelector("h1").textContent = `Welcome back, ${data.lastName}!`;
          welcomeDiv.querySelector("p").textContent = `${data.program} Student • ${data.researchArea}`;


          const abbreviation = data.abbreviations
          const userRow = document.querySelector(".user-row");

          const avatarDiv = userRow.querySelector(".avatar");
          const sideBarName = userRow.querySelector(".name");
          const sidebarRole = userRow.querySelector(".role");


          avatarDiv.textContent = abbreviation;
          sideBarName.textContent = data.lastName;
          sidebarRole.textContent = `${data.program} Student`;


          const recents = data.recents;
          const recentsList = document.getElementById("recent-items");

          recents.forEach(r => {
            const submissionDate = new Date(r.date);
            const now = new Date();
            const diffMs = now - submissionDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Determine background color based on status
            let bgColor = "#ffe066";  // default yellow
            let textColor = "#665c00"; // default text color

            if (r.status.toUpperCase() === "ACCEPTED") {
              bgColor = "#d7ffd7";    // green background
              textColor = "#257942";   // green text
            } else if (r.status.toUpperCase() === "REJECTED") {
              bgColor = "#ffd7d7";    // red background
              textColor = "#a00000";   // red text
            } // else keep yellow for pending

            const li = document.createElement("li");
            li.innerHTML = `
                    <strong>${r.chapter}</strong>
                    <span style="color:#7b8896;">Submitted ${diffDays} days ago</span>
                    <span style="background:${bgColor};color:${textColor};padding:2px 10px;border-radius:6px;margin-left:10px;font-size:12px;">${r.status}</span>
                `;

            recentsList.appendChild(li);
          });







          // render Area Chart
          const ctx1 = document.getElementById('areaChart').getContext('2d');
          const gradient = ctx1.createLinearGradient(0, 0, 0, 300);
          gradient.addColorStop(0, 'rgba(47,110,232,0.18)');
          gradient.addColorStop(1, 'rgba(47,110,232,0.02)');

          // Prepare data for the chart

          // Labels are months
          const labels = monthly.map(m => m.month);

          console.log("labels: ", labels)

          // Total Y-axis values
          const totals = monthly.map(m =>
                  ['submissions', 'meetings'].reduce((sum, key) => sum + (m[key] || 0), 0)
          );

          console.log("Totals: ", totals)


          // Custom tooltip callback to show breakdown
          const tooltipCallbacks = {
            callbacks: {
              label: function (context) {
                const monthData = monthly[context.dataIndex];
                const submissions = monthData.submissions || 0;
                const meetings = monthData.meetings || 0;
                return [`Submission: ${submissions}`, `Meetings: ${meetings}`];
              }
            }
          };

          new Chart(ctx1, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Total',
                data: totals,
                fill: true,
                backgroundColor: gradient,
                borderColor: '#2f6ee8',
                tension: 0.35,
                pointRadius: 3,
                pointBackgroundColor: '#2f6ee8',
                borderWidth: 2
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: {display: false},
                tooltip: tooltipCallbacks
              },
              scales: {
                x: {grid: {display: false}, ticks: {color: '#667085'}},
                y: {
                  ticks: {color: '#667085', precision: 0},
                  grid: {color: '#eef3ff'}
                }
              }
            }
          });




          // Render Doghtnut chart
          const ctx2 = document.getElementById('donutChart').getContext('2d');
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['Submitted', 'Remaining'],
              datasets: [{
                data: [totalSubmittedForStudentChapter, totalChapters],
                backgroundColor: ['#2f6ee8', '#e6eefc'],
                hoverBackgroundColor: ['#2f6ee8', '#e6eefc'],
                borderWidth: 0
              }]
            },
            options: {
              maintainAspectRatio: false,
              cutout: '68%',
              plugins: {
                legend: {display: false},
                tooltip: {callbacks: {label: (ctx) => ctx.label + ': ' + ctx.parsed}}
              }
            }
          });

          // add center text for percent
          // Chart.js v4 doesn't provide easy center text; this draws over the canvas.
          const canvas = document.getElementById('donutChart');
          const ctx3 = canvas.getContext('2d');

          function drawCenter() {
            const width = canvas.width;
            const height = canvas.height;
            // wait a tick to ensure chart is drawn
            setTimeout(() => {
              ctx3.save();
              ctx3.font = '600 18px Inter, Arial';
              ctx3.fillStyle = '#0f1724';
              ctx3.textAlign = 'center';
              ctx3.textBaseline = 'middle';
              ctx3.fillText('25%', width / 2, height / 2);
              ctx3.restore();
            }, 120);
          }

          drawCenter();


          // Render weekly chart
          const ctx4 = document.getElementById('weeklyBarChart').getContext('2d');

          new Chart(ctx4, {
            type: 'bar',
            data: {
              labels: weekly.map(w => w.week),         // dynamically set week labels
              datasets: [{
                label: 'Submissions',
                data: weekly.map(w => w.count),       // dynamically set data
                backgroundColor: '#2f6ee8'
              }]
            },
            options: {
              maintainAspectRatio: false,
              plugins: {
                legend: {display: false},
                tooltip: {mode: 'index', intersect: false}
              },
              scales: {
                x: {grid: {display: false}, ticks: {color: '#667085'}},
                y: {
                  beginAtZero: true,
                  suggestedMin: 0,
                  min: 0,
                  ticks: {
                    color: '#667085',
                    stepSize: 1,    // Increment by 1
                    precision: 0
                  },
                  grid: {color: '#eef3ff'}
                }
              }
            }
          });


          return {
            monthly, weekly, totalChapters,
            totalCompletedChapters, totalSubmittedForStudentChapter,
            totalPendingReviews, currentChapter
          };

        } catch (e) {
          alert("An error occurred: " + e);
          console.log("An error occurred: " + e);
          return {monthly: [], weekly: []};
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("userId");

        if (!userId) {
          window.location.href = "login.html"
          return;
        }
        document.querySelectorAll('nav a[href$=".html"]').forEach(link => {
          const url = new URL(link.getAttribute("href"), window.location.origin);
          url.searchParams.set("userId", userId);
          link.href = url.pathname + "?" + url.searchParams.toString();
        });


        // populate
        fetchReportData();
      });

    </script>
  </main>
</div>
</body>
</html>
